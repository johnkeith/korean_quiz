<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Korean Quiz">
    <link rel="apple-touch-icon" href="icon-180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
    <title>Korean Quiz</title>
    <style>
        @font-face {
            font-family: 'HiMelody';
            src: url('HiMelody-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
            -webkit-font-smoothing: antialiased;
        }

        /* App Container */
        .app {
            height: 100%;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .content-wrapper {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* Page transitions */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s ease;
            will-change: transform, opacity;
        }

        .page.hidden {
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
        }

        .page.slide-out {
            transform: translateX(-30%);
            opacity: 0.5;
        }

        /* Home Page */
        #home-page {
            background-color: #f5f5f5;
        }

        .app-title {
            padding: 24px;
            padding-top: calc(24px + env(safe-area-inset-top));
            padding-left: max(24px, env(safe-area-inset-left));
            padding-right: max(24px, env(safe-area-inset-right));
            text-align: center;
            background-color: #fff;
            border-bottom: 1px solid #eee;
        }

        .app-title h1 {
            font-family: 'HiMelody', sans-serif;
            font-size: clamp(42px, 9vw, 60px);
            font-weight: 400;
            color: #1a1a1a;
            letter-spacing: 0;
        }

        .menu-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .menu-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: filter 0.15s ease;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .menu-item:active {
            filter: brightness(0.9);
        }

        .menu-item-content {
            width: 100%;
            max-width: 600px;
            padding: 0 24px;
        }

        .menu-item h2 {
            font-size: clamp(28px, 7vw, 42px);
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            letter-spacing: -0.5px;
        }

        /* Korean flag colors */
        .menu-item:nth-child(1) {
            background: linear-gradient(180deg, #C60C30 0%, #e01e3c 100%);
        }

        .menu-item:nth-child(2) {
            background: linear-gradient(180deg, #003478 0%, #0a4a9c 100%);
        }

        .menu-item:nth-child(3) {
            background: linear-gradient(180deg, #1a1a1a 0%, #333333 100%);
        }

        /* Section Pages */
        .section-page {
            background-color: #f5f5f5;
        }

        .page-header {
            background: linear-gradient(180deg, #C60C30 0%, #e01e3c 100%);
            display: flex;
            justify-content: center;
        }

        .page-header-content {
            width: 100%;
            max-width: 600px;
            padding: 24px;
            padding-top: calc(24px + env(safe-area-inset-top));
            padding-left: max(24px, env(safe-area-inset-left));
            padding-right: max(24px, env(safe-area-inset-right));
        }

        .page-header h1 {
            font-size: clamp(24px, 6vw, 32px);
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }

        /* Different header colors for each page - matching menu items */
        #quiz-page .page-header {
            background: linear-gradient(180deg, #C60C30 0%, #e01e3c 100%);
        }

        #words-page .page-header {
            background: linear-gradient(180deg, #003478 0%, #0a4a9c 100%);
        }

        #settings-page .page-header {
            background: linear-gradient(180deg, #1a1a1a 0%, #333333 100%);
        }

        .page-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            justify-content: center;
        }

        .page-content-inner {
            width: 100%;
            max-width: 600px;
            padding: 20px 24px;
        }

        .bottom-spacer {
            height: 40px;
        }

        /* Content Styles */
        .section {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .section h2 {
            color: #1a1a1a;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .section p {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        input[type="file"] {
            display: block;
            margin: 12px 0;
            color: #1a1a1a;
            font-size: 14px;
        }

        input[type="file"]::file-selector-button {
            background: #003478;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            margin-right: 12px;
        }

        button {
            background: linear-gradient(180deg, #C60C30 0%, #a00a28 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.15s ease, filter 0.15s ease;
            -webkit-tap-highlight-color: transparent;
        }

        button:active {
            transform: scale(0.98);
            filter: brightness(0.9);
        }

        button:disabled {
            background: #ccc;
            color: #888;
            cursor: not-allowed;
        }

        .btn-danger {
            background: linear-gradient(180deg, #C60C30 0%, #a00a28 100%);
        }

        .btn-secondary {
            background: linear-gradient(180deg, #003478 0%, #002855 100%);
        }

        .btn-dark {
            background: linear-gradient(180deg, #1a1a1a 0%, #333333 100%);
        }

        .btn-upload {
            width: 50%;
        }

        .btn-clear {
            background: #C60C30;
            padding: 4px 10px;
            font-size: 12px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-header h2 {
            margin-bottom: 0;
        }

        #currentWord {
            font-size: clamp(24px, 6vw, 32px);
            font-weight: bold;
            text-align: center;
            padding: 30px 20px;
            min-height: 150px;
        }

        #currentWord .english {
            color: #1a1a1a;
        }

        #currentWord .korean {
            color: #1a1a1a;
            margin-top: 16px;
            font-size: clamp(72px, 20vw, 112px);
        }

        #progress {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .quiz-controls-top {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .quiz-controls-top button {
            flex: 1;
            padding: 16px 24px;
            font-size: 18px;
        }

        /* Quiz mode selection */
        .mode-selection {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 20px 0;
        }

        .mode-btn {
            padding: 32px 24px;
            font-size: 22px;
            font-weight: 600;
            border-radius: 16px;
            text-align: center;
        }

        .mode-btn-handsfree {
            background: linear-gradient(180deg, #003478 0%, #002855 100%);
        }

        .mode-btn-manual {
            background: linear-gradient(180deg, #34a853 0%, #2d9248 100%);
        }

        .mode-btn .mode-desc {
            display: block;
            font-size: 14px;
            font-weight: 400;
            opacity: 0.85;
            margin-top: 8px;
        }

        .quiz-active-area {
            display: none;
        }

        .quiz-active-area.visible {
            display: block;
        }

        .mode-selection.hidden {
            display: none;
        }

        .quiz-filter-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 15px 5px;
            background: #f5f5f5;
            border-radius: 12px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .quiz-filter-option input[type="checkbox"] {
            width: 32px;
            height: 32px;
            accent-color: #003478;
            cursor: pointer;
            flex-shrink: 0;
        }

        .quiz-filter-option span {
            font-size: 18px;
            color: #333;
        }

        .quiz-filter-option input[type="checkbox"]:checked {
            accent-color: #34a853;
        }

        /* Voice settings */
        .voice-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .voice-row label {
            min-width: 70px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .voice-row select {
            flex: 1;
            min-width: 150px;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
            color: #1a1a1a;
        }

        .voice-row button {
            padding: 10px 16px;
            font-size: 14px;
        }

        .no-voices {
            color: #C60C30;
            font-size: 14px;
            margin-top: 8px;
        }

        /* Word list */
        .word-list-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 12px;
            border-radius: 8px;
            background: #f9f9f9;
            border: 1px solid #eee;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #003478;
            font-weight: 600;
            color: #fff;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        td {
            color: #333;
            font-size: 14px;
        }

        .no-words {
            color: #888;
            font-style: italic;
            text-align: center;
            padding: 30px 20px;
        }

        .btn-remove {
            background: transparent;
            color: #C60C30;
            border: 1px solid #C60C30;
            padding: 6px 12px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px;
        }

        .btn-remove:active {
            background: #C60C30;
            color: white;
        }

        /* Settings specific */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #eee;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            color: #1a1a1a;
            font-size: 16px;
        }

        .setting-value {
            color: #666;
            font-size: 14px;
        }

        /* Speed slider */
        .speed-setting {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .speed-setting label {
            display: block;
            color: #333;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .speed-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .speed-row input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: #ddd;
            border-radius: 3px;
            outline: none;
        }

        .speed-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #003478;
            border-radius: 50%;
            cursor: pointer;
        }

        .speed-value {
            color: #1a1a1a;
            font-size: 14px;
            min-width: 45px;
            text-align: right;
        }

        /* Radio buttons */
        .radio-setting {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .radio-setting>label {
            display: block;
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: #003478;
            cursor: pointer;
        }

        .radio-option span {
            color: #1a1a1a;
            font-size: 14px;
        }

        /* Response buttons for spaced repetition */
        .response-section {
            display: none;
            background: #fff;
            border-top: 1px solid #eee;
            padding: 16px 20px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
        }

        .response-section.visible {
            display: block;
        }

        .response-section h3 {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            text-align: center;
        }

        .response-buttons {
            display: flex;
            flex-direction: row-reverse;
            gap: 12px;
        }

        @media (max-width: 500px) {
            .response-buttons {
                flex-direction: column;
                gap: 16px;
            }
        }

        .response-buttons button {
            flex: 1;
            padding: 14px 12px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
        }

        .btn-yes {
            background: linear-gradient(180deg, #34a853 0%, #2d9248 100%);
        }

        .btn-maybe {
            background: linear-gradient(180deg, #f97316 0%, #ea580c 100%);
        }

        .btn-no {
            background: linear-gradient(180deg, #ea4335 0%, #d33426 100%);
        }

        .response-buttons button:disabled {
            background: #ccc;
            color: #888;
        }

        .response-buttons button.selected {
            box-shadow: inset 0 0 0 100px rgba(0, 0, 0, 0.2);
        }

        .response-buttons button.unselected {
            opacity: 0.4;
        }

        .btn-reveal {
            display: none;
            width: 100%;
            padding: 14px 12px;
            font-size: 16px;
            background: linear-gradient(180deg, #003478 0%, #002855 100%);
        }

        .btn-reveal.visible {
            display: block;
        }

        .response-buttons.hidden {
            display: none;
        }

        /* Sortable table */
        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            background-color: #004590;
        }

        th.sortable::after {
            content: '';
            margin-left: 6px;
        }

        th.sortable.asc::after {
            content: '▲';
        }

        th.sortable.desc::after {
            content: '▼';
        }

        /* Rating badges */
        .rating-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .rating-good {
            background: #d4edda;
            color: #155724;
        }

        .rating-neutral {
            background: #ffedd5;
            color: #c2410c;
        }

        .rating-poor {
            background: #f8d7da;
            color: #721c24;
        }

        .rating-unknown {
            background: #e9ecef;
            color: #6c757d;
        }

        /* Word stats */
        .word-stats {
            margin-bottom: 16px;
        }

        .word-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .word-stat:last-child {
            border-bottom: none;
        }

        .word-stat .count {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }
    </style>
</head>

<body>
    <div class="app">
        <!-- Home Page -->
        <div id="home-page" class="page">
            <div class="app-title">
                <h1>연습, 연습, 연습!</h1>
            </div>
            <div class="menu-container">
                <div class="menu-item" onclick="navigateTo('quiz')">
                    <div class="menu-item-content">
                        <h2>Quiz</h2>
                    </div>
                </div>
                <div class="menu-item" onclick="navigateTo('words')">
                    <div class="menu-item-content">
                        <h2>Words</h2>
                    </div>
                </div>
                <div class="menu-item" onclick="navigateTo('settings')">
                    <div class="menu-item-content">
                        <h2>Settings</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Page -->
        <div id="quiz-page" class="page section-page hidden">
            <div class="page-header">
                <div class="page-header-content">
                    <h1>Quiz</h1>
                </div>
            </div>
            <div class="page-content">
                <div class="page-content-inner">
                    <!-- Mode Selection -->
                    <div id="modeSelection" class="mode-selection">
                        <button class="mode-btn mode-btn-handsfree" onclick="startQuizMode('handsfree')">
                            Hands Free
                            <span class="mode-desc">Auto-advances through words</span>
                        </button>
                        <button class="mode-btn mode-btn-manual" onclick="startQuizMode('manual')">
                            Manual
                            <span class="mode-desc">Rate each word to continue</span>
                        </button>
                        <label class="quiz-filter-option">
                            <input type="checkbox" id="reviewOnlyWeak" onchange="saveQuizFilter()">
                            <span>Review only weak words</span>
                        </label>
                    </div>

                    <!-- Active Quiz Area -->
                    <div id="quizActiveArea" class="quiz-active-area">
                        <div class="quiz-controls-top">
                            <button id="startPauseBtn" onclick="toggleStartPause()">Pause</button>
                            <button id="stopBtn" onclick="stopQuiz()" class="btn-danger">Stop</button>
                        </div>
                        <div class="section">
                            <div id="currentWord"></div>
                            <div id="progress"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="responseSection" class="response-section">
                <h3>Word Recall</h3>
                <button id="btnReveal" class="btn-reveal" onclick="revealAnswer()">Reveal</button>
                <div id="ratingButtons" class="response-buttons">
                    <button id="btnYes" class="btn-yes" onclick="recordResponse('good')" disabled>Yes!</button>
                    <button id="btnMaybe" class="btn-maybe" onclick="recordResponse('neutral')"
                        disabled>Maybe...</button>
                    <button id="btnNo" class="btn-no" onclick="recordResponse('poor')" disabled>No.</button>
                </div>
            </div>
        </div>

        <!-- Words Page -->
        <div id="words-page" class="page section-page hidden">
            <div class="page-header">
                <div class="page-header-content">
                    <h1>Words</h1>
                </div>
            </div>
            <div class="page-content">
                <div class="page-content-inner">
                    <div class="section">
                        <h2>Upload CSV</h2>
                        <p>Upload a CSV file with terms to study. Put the English words in column A and their Korean
                            definitions in column B.</p>
                        <input type="file" id="csvFile" accept=".csv">
                        <button onclick="handleUpload()" class="btn-upload">Upload</button>
                    </div>

                    <div class="section">
                        <div class="section-header">
                            <h2>Loaded Words (<span id="wordCount">0</span>)</h2>
                            <button onclick="clearWords()" class="btn-clear">Clear All</button>
                        </div>
                        <div id="wordStats" class="word-stats"></div>
                        <div class="word-list-container">
                            <div id="wordList"></div>
                        </div>
                    </div>
                    <div class="bottom-spacer"></div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings-page" class="page section-page hidden">
            <div class="page-header">
                <div class="page-header-content">
                    <h1>Settings</h1>
                </div>
            </div>
            <div class="page-content">
                <div class="page-content-inner">
                    <div class="section">
                        <h2>Voice Settings</h2>
                        <div class="voice-row">
                            <label>English:</label>
                            <select id="englishVoice"></select>
                            <button onclick="testVoice('en')" class="btn-secondary">Test</button>
                        </div>
                        <div class="voice-row">
                            <label>Korean:</label>
                            <select id="koreanVoice"></select>
                            <button onclick="testVoice('ko')" class="btn-secondary">Test</button>
                        </div>
                        <div id="voiceStatus"></div>

                        <div class="speed-setting">
                            <label>Korean Speech Speed</label>
                            <div class="speed-row">
                                <input type="range" id="koreanSpeed" min="50" max="100" value="80"
                                    oninput="updateSpeed()">
                                <span class="speed-value" id="speedValue">80%</span>
                            </div>
                        </div>

                        <div class="speed-setting">
                            <label>Pause Between Words (seconds)</label>
                            <div class="speed-row">
                                <input type="range" id="pauseDuration" min="1" max="10" value="3"
                                    oninput="updatePauseDuration()">
                                <span class="speed-value" id="pauseValue">3s</span>
                            </div>
                        </div>

                        <div class="radio-setting">
                            <label>First Word Spoken</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="firstWord" value="english" checked
                                        onchange="updateFirstWord()">
                                    <span>English</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="firstWord" value="korean" onchange="updateFirstWord()">
                                    <span>Korean</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Backup & Restore</h2>
                        <p>Download a backup of all your words, ratings, and progress.</p>
                        <button onclick="downloadBackup()" class="btn-secondary"
                            style="width: 100%; margin-top: 12px;">Download Backup</button>

                        <p style="margin-top: 20px;">Restore from a previous backup file.</p>
                        <input type="file" id="restoreFile" accept=".json" style="margin-top: 8px;">
                        <button onclick="restoreBackup()" class="btn-dark"
                            style="width: 100%; margin-top: 12px;">Restore from Backup</button>
                    </div>

                    <div class="section">
                        <h2>About</h2>
                        <div class="setting-item">
                            <span class="setting-label">Version</span>
                            <span class="setting-value">1.4.7</span>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Words Loaded</span>
                            <span class="setting-value" id="settingsWordCount">0</span>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Reset</h2>
                        <p>Clear all words, ratings, and settings.</p>
                        <button onclick="clearAllData()" class="btn-danger" style="width: 100%; margin-top: 12px;">Clear
                            All Data</button>
                    </div>
                    <div class="bottom-spacer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let words = [];
        let isQuizRunning = false;
        let stopRequested = false;
        let selectedVoices = {
            en: null,
            ko: null
        };
        let koreanSpeed = 0.8;
        let pauseDuration = 3;
        let isPaused = false;
        let firstWord = 'english';
        let currentPage = 'home';
        let quizMode = null; // 'handsfree' or 'manual'
        let manualAdvance = false; // Flag for manual mode to advance to next word
        let skipToNextWord = false; // Flag to skip remaining steps for current word
        let reviewOnlyWeak = false; // Filter to only review Maybe & Poor words

        // Spaced repetition tracking
        let wordKnowledge = {}; // { "id": "good"|"neutral"|"poor"|"unknown" }
        let shownWords = new Set(); // Track words shown in current/continued session
        let currentQuizWord = null; // Currently displayed word for response buttons

        // Word list sorting
        let sortColumn = 'rating'; // 'english', 'korean', 'rating'
        let sortDirection = 'desc'; // 'asc' or 'desc'


        // Navigation
        function navigateTo(page) {
            const homePage = document.getElementById('home-page');
            const targetPage = document.getElementById(page + '-page');

            if (!targetPage) return;

            // Update URL hash
            history.pushState({ page: page }, '', '#' + page);

            // Animate transition
            homePage.classList.add('slide-out');
            targetPage.classList.remove('hidden');

            currentPage = page;

            // Update word counts when navigating
            if (page === 'settings') {
                document.getElementById('settingsWordCount').textContent = words.length;
            }
        }

        function showHomePage() {
            const homePage = document.getElementById('home-page');
            const pages = document.querySelectorAll('.section-page');

            homePage.classList.remove('slide-out');
            pages.forEach(page => {
                page.classList.add('hidden');
            });

            currentPage = 'home';
        }

        // Handle browser back/forward
        window.addEventListener('popstate', (event) => {
            // Stop quiz if navigating away
            if (currentPage === 'quiz') {
                stopQuiz();
            }

            if (event.state && event.state.page) {
                const targetPage = document.getElementById(event.state.page + '-page');
                const homePage = document.getElementById('home-page');
                const pages = document.querySelectorAll('.section-page');

                pages.forEach(page => {
                    if (page.id === event.state.page + '-page') {
                        page.classList.remove('hidden');
                    } else {
                        page.classList.add('hidden');
                    }
                });

                homePage.classList.add('slide-out');
                currentPage = event.state.page;
            } else {
                showHomePage();
            }
        });

        // Handle initial hash on page load
        function handleInitialRoute() {
            const hash = window.location.hash.slice(1);
            if (hash && ['quiz', 'words', 'settings'].includes(hash)) {
                const targetPage = document.getElementById(hash + '-page');
                const homePage = document.getElementById('home-page');

                if (targetPage) {
                    history.replaceState({ page: hash }, '', '#' + hash);
                    homePage.classList.add('slide-out');
                    targetPage.classList.remove('hidden');
                    currentPage = hash;
                }
            }
        }

        // Load words from localStorage on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            loadWordKnowledge();
            loadShownWords();
            displayWords();
            loadVoicePreferences();
            loadSpeedSetting();
            loadPauseDuration();
            loadFirstWord();
            loadQuizFilter();
            populateVoiceSelectors();
            handleInitialRoute();
        });

        // Voices may load asynchronously
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => {
                populateVoiceSelectors();
            };
        }

        function loadFromStorage() {
            const stored = localStorage.getItem('vocabWords');
            if (stored) {
                words = JSON.parse(stored);
                // Migrate: Add IDs to words that don't have them
                let needsSave = false;
                const oldKnowledge = JSON.parse(localStorage.getItem('wordKnowledge') || '{}');
                const oldShownWords = new Set(JSON.parse(localStorage.getItem('shownWords') || '[]'));
                let knowledgeNeedsMigration = false;
                let shownNeedsMigration = false;

                words.forEach(word => {
                    if (!word.id) {
                        word.id = generateWordId();
                        needsSave = true;

                        const oldKey = `${word.english}|${word.korean}`;

                        // Migrate word knowledge from old key format to new ID
                        if (oldKnowledge[oldKey] && !oldKnowledge[word.id]) {
                            oldKnowledge[word.id] = oldKnowledge[oldKey];
                            delete oldKnowledge[oldKey];
                            knowledgeNeedsMigration = true;
                        }

                        // Migrate shown words from old key format to new ID
                        if (oldShownWords.has(oldKey)) {
                            oldShownWords.delete(oldKey);
                            oldShownWords.add(word.id);
                            shownNeedsMigration = true;
                        }
                    }
                });

                if (needsSave) {
                    saveToStorage();
                }
                if (knowledgeNeedsMigration) {
                    localStorage.setItem('wordKnowledge', JSON.stringify(oldKnowledge));
                }
                if (shownNeedsMigration) {
                    localStorage.setItem('shownWords', JSON.stringify([...oldShownWords]));
                }
            }
        }

        function saveToStorage() {
            localStorage.setItem('vocabWords', JSON.stringify(words));
        }

        function loadVoicePreferences() {
            const stored = localStorage.getItem('voicePreferences');
            if (stored) {
                selectedVoices = JSON.parse(stored);
            }
        }

        function saveVoicePreferences() {
            localStorage.setItem('voicePreferences', JSON.stringify(selectedVoices));
        }

        function loadSpeedSetting() {
            const stored = localStorage.getItem('koreanSpeed');
            if (stored) {
                koreanSpeed = parseFloat(stored);
                document.getElementById('koreanSpeed').value = koreanSpeed * 100;
                document.getElementById('speedValue').textContent = Math.round(koreanSpeed * 100) + '%';
            }
        }

        function updateSpeed() {
            const slider = document.getElementById('koreanSpeed');
            koreanSpeed = slider.value / 100;
            document.getElementById('speedValue').textContent = slider.value + '%';
            localStorage.setItem('koreanSpeed', koreanSpeed.toString());
        }

        function loadPauseDuration() {
            const stored = localStorage.getItem('pauseDuration');
            if (stored) {
                pauseDuration = parseInt(stored);
                document.getElementById('pauseDuration').value = pauseDuration;
                document.getElementById('pauseValue').textContent = pauseDuration + 's';
            }
        }

        function updatePauseDuration() {
            const slider = document.getElementById('pauseDuration');
            pauseDuration = parseInt(slider.value);
            document.getElementById('pauseValue').textContent = pauseDuration + 's';
            localStorage.setItem('pauseDuration', pauseDuration.toString());
        }

        function loadFirstWord() {
            const stored = localStorage.getItem('firstWord');
            if (stored) {
                firstWord = stored;
                document.querySelector(`input[name="firstWord"][value="${firstWord}"]`).checked = true;
            }
        }

        function updateFirstWord() {
            const selected = document.querySelector('input[name="firstWord"]:checked');
            firstWord = selected.value;
            localStorage.setItem('firstWord', firstWord);
        }

        function loadQuizFilter() {
            const stored = localStorage.getItem('reviewOnlyWeak');
            if (stored) {
                reviewOnlyWeak = stored === 'true';
                document.getElementById('reviewOnlyWeak').checked = reviewOnlyWeak;
            }
        }

        function saveQuizFilter() {
            reviewOnlyWeak = document.getElementById('reviewOnlyWeak').checked;
            localStorage.setItem('reviewOnlyWeak', reviewOnlyWeak.toString());
        }

        function generateWordId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function getWordKey(word) {
            return word.id || `${word.english}|${word.korean}`;
        }

        function loadWordKnowledge() {
            const stored = localStorage.getItem('wordKnowledge');
            if (stored) {
                wordKnowledge = JSON.parse(stored);
            }
        }

        function saveWordKnowledge() {
            localStorage.setItem('wordKnowledge', JSON.stringify(wordKnowledge));
        }

        function loadShownWords() {
            const stored = localStorage.getItem('shownWords');
            if (stored) {
                shownWords = new Set(JSON.parse(stored));
            }
        }

        function saveShownWords() {
            localStorage.setItem('shownWords', JSON.stringify([...shownWords]));
        }

        function getWordKnowledgeLevel(word) {
            const key = getWordKey(word);
            return wordKnowledge[key] || 'unknown';
        }

        function setWordKnowledgeLevel(word, level) {
            const key = getWordKey(word);
            wordKnowledge[key] = level;
            saveWordKnowledge();
        }

        function recordResponse(level) {
            if (currentQuizWord) {
                setWordKnowledgeLevel(currentQuizWord, level);

                // Clear previous selection
                document.querySelectorAll('.response-buttons button').forEach(btn => {
                    btn.classList.remove('selected', 'unselected');
                });

                // Mark the selected button and dim others
                const btnId = level === 'good' ? 'btnYes' : level === 'neutral' ? 'btnMaybe' : 'btnNo';
                const btn = document.getElementById(btnId);
                btn.classList.add('selected');

                // Mark other buttons as unselected
                document.querySelectorAll('.response-buttons button').forEach(b => {
                    if (b !== btn) {
                        b.classList.add('unselected');
                    }
                });

                // Brief animation feedback
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => btn.style.transform = '', 150);

                // In manual mode, cancel speech and move to next word
                if (quizMode === 'manual') {
                    window.speechSynthesis.cancel();
                    skipToNextWord = true;
                }
            }
        }

        function clearResponseSelection() {
            document.querySelectorAll('#ratingButtons button').forEach(btn => {
                btn.classList.remove('selected', 'unselected');
            });
        }

        function resetManualUI() {
            // Reset for new word in manual mode
            document.getElementById('btnReveal').classList.remove('visible');
            document.getElementById('ratingButtons').classList.add('hidden');
            clearResponseSelection();
        }

        function showRevealButton() {
            document.getElementById('btnReveal').classList.add('visible');
            document.getElementById('ratingButtons').classList.add('hidden');
        }

        function revealAnswer() {
            window.speechSynthesis.cancel();
            document.getElementById('btnReveal').classList.remove('visible');
            document.getElementById('ratingButtons').classList.remove('hidden');
            manualAdvance = true;
        }

        function startQuizMode(mode) {
            if (words.length === 0) {
                alert('No words loaded. Please upload a CSV first.');
                return;
            }

            // Check if filter is enabled but no matching words
            if (reviewOnlyWeak) {
                const weakWords = words.filter(w => {
                    const level = getWordKnowledgeLevel(w);
                    return level === 'poor' || level === 'neutral';
                });
                if (weakWords.length === 0) {
                    alert('No Maybe or Poor words to review. Uncheck the filter or rate some words first.');
                    return;
                }
            }

            quizMode = mode;
            manualAdvance = false;

            // Hide mode selection, show quiz area
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('quizActiveArea').classList.add('visible');

            // Start the quiz
            startQuiz();
        }

        function toggleStartPause() {
            if (!isQuizRunning) {
                // Not running, so start the quiz
                startQuiz();
            } else {
                // Running, so toggle pause
                isPaused = !isPaused;
                const btn = document.getElementById('startPauseBtn');
                if (isPaused) {
                    btn.textContent = 'Resume';
                    btn.classList.remove('btn-secondary');
                    window.speechSynthesis.pause();
                } else {
                    btn.textContent = 'Pause';
                    btn.classList.add('btn-secondary');
                    window.speechSynthesis.resume();
                }
            }
        }

        function populateVoiceSelectors() {
            const voices = window.speechSynthesis.getVoices();
            const englishSelect = document.getElementById('englishVoice');
            const koreanSelect = document.getElementById('koreanVoice');
            const voiceStatus = document.getElementById('voiceStatus');

            // Filter voices by language
            const englishVoices = voices.filter(v => v.lang.startsWith('en'));
            const koreanVoices = voices.filter(v => v.lang.startsWith('ko'));

            // Populate English voices
            englishSelect.innerHTML = '';
            if (englishVoices.length === 0) {
                englishSelect.innerHTML = '<option value="">No English voices available</option>';
            } else {
                englishVoices.sort((a, b) => {
                    const aScore = getVoiceScore(a);
                    const bScore = getVoiceScore(b);
                    if (bScore !== aScore) return bScore - aScore;
                    return a.name.localeCompare(b.name);
                });

                englishVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    if (selectedVoices.en === voice.name) {
                        option.selected = true;
                    }
                    englishSelect.appendChild(option);
                });

                if (!selectedVoices.en && englishVoices.length > 0) {
                    // Prefer Samantha as default
                    const samantha = englishVoices.find(v => v.name.includes('Samantha'));
                    selectedVoices.en = samantha ? samantha.name : englishVoices[0].name;
                }
            }

            // Populate Korean voices
            koreanSelect.innerHTML = '';
            if (koreanVoices.length === 0) {
                koreanSelect.innerHTML = '<option value="">No Korean voices available</option>';
                voiceStatus.innerHTML = '<p class="no-voices">No Korean voices found. Check System Settings > Accessibility > Spoken Content to add Korean voices.</p>';
            } else {
                voiceStatus.innerHTML = '';

                koreanVoices.sort((a, b) => {
                    const aScore = getVoiceScore(a);
                    const bScore = getVoiceScore(b);
                    if (bScore !== aScore) return bScore - aScore;
                    return a.name.localeCompare(b.name);
                });

                koreanVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    if (selectedVoices.ko === voice.name) {
                        option.selected = true;
                    }
                    koreanSelect.appendChild(option);
                });

                if (!selectedVoices.ko && koreanVoices.length > 0) {
                    selectedVoices.ko = koreanVoices[0].name;
                }
            }

            englishSelect.onchange = () => {
                selectedVoices.en = englishSelect.value;
                saveVoicePreferences();
            };

            koreanSelect.onchange = () => {
                selectedVoices.ko = koreanSelect.value;
                saveVoicePreferences();
            };
        }

        function getVoiceScore(voice) {
            let score = 0;
            const nameLower = voice.name.toLowerCase();
            const premiumIndicators = ['premium', 'enhanced', 'natural', 'neural'];
            const preferredNames = ['Yuna', 'Sora', 'Samantha', 'Alex', 'Daniel', 'Karen', 'Google', 'Microsoft'];

            if (premiumIndicators.some(ind => nameLower.includes(ind))) score += 100;
            if (preferredNames.some(pref => voice.name.includes(pref))) score += 50;
            if (voice.localService) score += 20;

            return score;
        }

        function testVoice(lang) {
            const testText = lang === 'en' ? 'Hello, this is a test.' : '안녕하세요, 테스트입니다.';
            const fullLang = lang === 'en' ? 'en-US' : 'ko-KR';

            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(testText);
            utterance.lang = fullLang;

            const voiceName = lang === 'en' ? selectedVoices.en : selectedVoices.ko;
            if (voiceName) {
                const voices = window.speechSynthesis.getVoices();
                const voice = voices.find(v => v.name === voiceName);
                if (voice) {
                    utterance.voice = voice;
                }
            }

            utterance.rate = lang === 'ko' ? koreanSpeed : 0.9;
            window.speechSynthesis.speak(utterance);
        }

        function handleUpload() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file first.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/);

            // Build a map of existing words by Korean definition
            const existingByKorean = new Map();
            words.forEach(word => {
                existingByKorean.set(word.korean, word);
            });

            let newCount = 0;
            let updatedCount = 0;

            for (const line of lines) {
                if (!line.trim()) continue;

                const parts = parseCSVLine(line);

                if (parts.length >= 2) {
                    const english = parts[0].trim();
                    const korean = parts[1].trim();

                    if (english && korean) {
                        if (existingByKorean.has(korean)) {
                            // Update existing word's English if different
                            const existing = existingByKorean.get(korean);
                            if (existing.english !== english) {
                                existing.english = english;
                                updatedCount++;
                            }
                        } else {
                            // Add new word with unique ID
                            const newWord = {
                                id: generateWordId(),
                                english,
                                korean
                            };
                            existingByKorean.set(korean, newWord);
                            newCount++;
                        }
                    }
                }
            }

            // Convert map back to array
            words = Array.from(existingByKorean.values());

            saveToStorage();
            displayWords();
            document.getElementById('csvFile').value = '';

            if (newCount > 0 || updatedCount > 0) {
                let message = [];
                if (newCount > 0) message.push(`${newCount} new word(s) added`);
                if (updatedCount > 0) message.push(`${updatedCount} word(s) updated`);
                alert(message.join(', ') + `. Total: ${words.length} words.`);
            } else if (words.length > 0) {
                alert(`No new words to add. Total: ${words.length} words.`);
            } else {
                alert('No valid word pairs found in the CSV.');
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);

            return result.map(s => s.replace(/^"|"$/g, ''));
        }

        function getRatingBadge(level) {
            const labels = { good: 'Good', neutral: 'Maybe', poor: 'Poor', unknown: '—' };
            return `<span class="rating-badge rating-${level}">${labels[level]}</span>`;
        }

        function getSortedWords() {
            if (!sortColumn) {
                return words.map((word, index) => ({ word, originalIndex: index }));
            }

            const ratingOrder = { unknown: 0, poor: 1, neutral: 2, good: 3 };

            return words.map((word, index) => ({ word, originalIndex: index }))
                .sort((a, b) => {
                    let valA, valB;

                    if (sortColumn === 'english') {
                        valA = a.word.english.toLowerCase();
                        valB = b.word.english.toLowerCase();
                    } else if (sortColumn === 'korean') {
                        valA = a.word.korean;
                        valB = b.word.korean;
                    } else if (sortColumn === 'rating') {
                        valA = ratingOrder[getWordKnowledgeLevel(a.word)];
                        valB = ratingOrder[getWordKnowledgeLevel(b.word)];
                    }

                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
        }

        function sortWords(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            displayWords();
        }

        function displayWords() {
            const wordList = document.getElementById('wordList');
            const wordCount = document.getElementById('wordCount');
            const wordStats = document.getElementById('wordStats');

            wordCount.textContent = words.length;

            // Calculate stats
            let stats = { good: 0, neutral: 0, poor: 0, unknown: 0 };
            words.forEach(word => {
                const level = getWordKnowledgeLevel(word);
                stats[level]++;
            });

            // Display stats
            if (words.length > 0) {
                wordStats.innerHTML = `
                    <div class="word-stat"><span class="rating-badge rating-good">Good</span><span class="count">${stats.good}</span></div>
                    <div class="word-stat"><span class="rating-badge rating-neutral">Maybe</span><span class="count">${stats.neutral}</span></div>
                    <div class="word-stat"><span class="rating-badge rating-poor">Poor</span><span class="count">${stats.poor}</span></div>
                    <div class="word-stat"><span class="rating-badge rating-unknown">Unknown</span><span class="count">${stats.unknown}</span></div>
                `;
            } else {
                wordStats.innerHTML = '';
            }

            if (words.length === 0) {
                wordList.innerHTML = '<p class="no-words">No words loaded. Upload a CSV to get started.</p>';
                return;
            }

            const engClass = sortColumn === 'english' ? sortDirection : '';
            const korClass = sortColumn === 'korean' ? sortDirection : '';
            const ratingClass = sortColumn === 'rating' ? sortDirection : '';

            let html = `<table><thead><tr>
                <th>#</th>
                <th class="sortable ${engClass}" onclick="sortWords('english')">English</th>
                <th class="sortable ${korClass}" onclick="sortWords('korean')">Korean</th>
                <th class="sortable ${ratingClass}" onclick="sortWords('rating')">Rating</th>
                <th></th>
            </tr></thead><tbody>`;

            const sortedWords = getSortedWords();
            sortedWords.forEach(({ word, originalIndex }, displayIndex) => {
                const level = getWordKnowledgeLevel(word);
                html += `<tr>
                    <td>${displayIndex + 1}</td>
                    <td>${escapeHtml(word.english)}</td>
                    <td>${escapeHtml(word.korean)}</td>
                    <td>${getRatingBadge(level)}</td>
                    <td><button onclick="removeWord(${originalIndex})" class="btn-remove" title="Remove">&times;</button></td>
                </tr>`;
            });
            html += '</tbody></table>';

            wordList.innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearWords() {
            if (confirm('Are you sure you want to clear all words?')) {
                words = [];
                saveToStorage();
                displayWords();
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This will remove all words, ratings, and settings. This cannot be undone.')) {
                // Clear all app data from localStorage
                localStorage.removeItem('vocabWords');
                localStorage.removeItem('wordKnowledge');
                localStorage.removeItem('shownWords');
                localStorage.removeItem('voicePreferences');
                localStorage.removeItem('koreanSpeed');
                localStorage.removeItem('pauseDuration');
                localStorage.removeItem('firstWord');

                // Reset in-memory state
                words = [];
                wordKnowledge = {};
                shownWords = new Set();
                selectedVoices = { en: null, ko: null };
                koreanSpeed = 0.8;
                pauseDuration = 3;
                firstWord = 'english';

                // Update UI
                displayWords();
                document.getElementById('koreanSpeed').value = 80;
                document.getElementById('speedValue').textContent = '80%';
                document.getElementById('pauseDuration').value = 3;
                document.getElementById('pauseValue').textContent = '3s';
                document.querySelector('input[name="firstWord"][value="english"]').checked = true;
                document.getElementById('settingsWordCount').textContent = '0';
                populateVoiceSelectors();

                alert('All data has been cleared.');
            }
        }

        function downloadBackup() {
            const backup = {
                version: '1.4.7',
                exportDate: new Date().toISOString(),
                words: words,
                wordKnowledge: wordKnowledge,
                shownWords: [...shownWords],
                settings: {
                    voicePreferences: selectedVoices,
                    koreanSpeed: koreanSpeed,
                    pauseDuration: pauseDuration,
                    firstWord: firstWord
                }
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `korean-quiz-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function restoreBackup() {
            const fileInput = document.getElementById('restoreFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a backup file first.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);

                    // Validate backup structure
                    if (!backup.words || !Array.isArray(backup.words)) {
                        throw new Error('Invalid backup file: missing words data');
                    }

                    if (!confirm(`This will replace all current data with the backup from ${backup.exportDate ? new Date(backup.exportDate).toLocaleDateString() : 'unknown date'}. Continue?`)) {
                        return;
                    }

                    // Restore words
                    words = backup.words;
                    saveToStorage();

                    // Restore word knowledge
                    if (backup.wordKnowledge) {
                        wordKnowledge = backup.wordKnowledge;
                        saveWordKnowledge();
                    }

                    // Restore shown words
                    if (backup.shownWords) {
                        shownWords = new Set(backup.shownWords);
                        saveShownWords();
                    }

                    // Restore settings
                    if (backup.settings) {
                        if (backup.settings.voicePreferences) {
                            selectedVoices = backup.settings.voicePreferences;
                            saveVoicePreferences();
                        }
                        if (backup.settings.koreanSpeed !== undefined) {
                            koreanSpeed = backup.settings.koreanSpeed;
                            localStorage.setItem('koreanSpeed', koreanSpeed.toString());
                            document.getElementById('koreanSpeed').value = koreanSpeed * 100;
                            document.getElementById('speedValue').textContent = Math.round(koreanSpeed * 100) + '%';
                        }
                        if (backup.settings.pauseDuration !== undefined) {
                            pauseDuration = backup.settings.pauseDuration;
                            localStorage.setItem('pauseDuration', pauseDuration.toString());
                            document.getElementById('pauseDuration').value = pauseDuration;
                            document.getElementById('pauseValue').textContent = pauseDuration + 's';
                        }
                        if (backup.settings.firstWord) {
                            firstWord = backup.settings.firstWord;
                            localStorage.setItem('firstWord', firstWord);
                            document.querySelector(`input[name="firstWord"][value="${firstWord}"]`).checked = true;
                        }
                    }

                    // Update UI
                    displayWords();
                    document.getElementById('settingsWordCount').textContent = words.length;
                    populateVoiceSelectors();
                    fileInput.value = '';

                    alert(`Backup restored successfully! ${words.length} words loaded.`);
                } catch (error) {
                    alert('Error restoring backup: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function removeWord(index) {
            words.splice(index, 1);
            saveToStorage();
            displayWords();
        }

        function getOrderedWords() {
            // Start with all words, optionally filtered by weak-only setting
            let eligibleWords = words;
            if (reviewOnlyWeak) {
                eligibleWords = words.filter(w => {
                    const level = getWordKnowledgeLevel(w);
                    return level === 'poor' || level === 'neutral';
                });
            }

            // Check if all eligible words have been shown - if so, reset
            const allShown = eligibleWords.every(w => shownWords.has(getWordKey(w)));
            if (allShown) {
                shownWords.clear();
                saveShownWords();
            }

            // Filter to only unshown words
            const unshownWords = eligibleWords.filter(w => !shownWords.has(getWordKey(w)));

            // Categorize by knowledge level
            const poor = [];
            const neutral = [];
            const good = [];
            const unknown = [];

            unshownWords.forEach(word => {
                const level = getWordKnowledgeLevel(word);
                if (level === 'poor') poor.push(word);
                else if (level === 'neutral') neutral.push(word);
                else if (level === 'good') good.push(word);
                else unknown.push(word);
            });

            // Shuffle each category
            const shuffle = arr => arr.sort(() => Math.random() - 0.5);
            shuffle(poor);
            shuffle(neutral);
            shuffle(good);
            shuffle(unknown);

            // Return in priority order: poor, neutral, good, unknown
            return [...poor, ...neutral, ...good, ...unknown];
        }

        function enableResponseButtons(enabled) {
            document.getElementById('btnYes').disabled = !enabled;
            document.getElementById('btnMaybe').disabled = !enabled;
            document.getElementById('btnNo').disabled = !enabled;
        }

        async function startQuiz() {
            if (words.length === 0) {
                alert('No words loaded. Please upload a CSV first.');
                return;
            }

            if (isQuizRunning) return;

            isQuizRunning = true;
            stopRequested = false;
            manualAdvance = false;

            document.getElementById('startPauseBtn').textContent = 'Pause';
            document.getElementById('startPauseBtn').classList.add('btn-secondary');
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('responseSection').classList.add('visible');
            isPaused = false;

            // Set up UI based on mode
            if (quizMode === 'manual') {
                document.getElementById('startPauseBtn').style.display = 'none';
                document.getElementById('ratingButtons').classList.add('hidden');
                enableResponseButtons(true);
            } else {
                enableResponseButtons(true);
            }

            const currentWordEl = document.getElementById('currentWord');
            const progress = document.getElementById('progress');

            const orderedWords = getOrderedWords();

            for (let i = 0; i < orderedWords.length; i++) {
                if (stopRequested) break;

                const word = orderedWords[i];
                currentQuizWord = word;
                manualAdvance = false;
                skipToNextWord = false;

                // Reset UI for new word
                if (quizMode === 'manual') {
                    resetManualUI();
                } else {
                    clearResponseSelection();
                }

                // Mark word as shown and persist
                shownWords.add(getWordKey(word));
                saveShownWords();

                progress.textContent = `Word ${i + 1} of ${orderedWords.length}`;

                const first = firstWord === 'english' ? { text: word.english, lang: 'en-US', class: 'english' } : { text: word.korean, lang: 'ko-KR', class: 'korean' };
                const second = firstWord === 'english' ? { text: word.korean, lang: 'ko-KR', class: 'korean' } : { text: word.english, lang: 'en-US', class: 'english' };

                currentWordEl.innerHTML = `<div class="${first.class}">${escapeHtml(first.text)}</div>`;

                // In manual mode, show Reveal button immediately
                if (quizMode === 'manual') {
                    showRevealButton();
                }

                await speak(first.text, first.lang);

                if (stopRequested) continue;

                // In manual mode, wait for reveal
                if (quizMode === 'manual') {
                    await waitForManualAdvance();
                    if (stopRequested) continue;
                    manualAdvance = false;
                } else {
                    await pauseDelay(pauseDuration * 1000);
                    if (stopRequested) continue;
                }

                if (stopRequested || skipToNextWord) continue;

                currentWordEl.innerHTML = `
                    <div class="${first.class}">${escapeHtml(first.text)}</div>
                    <div class="${second.class}">${escapeHtml(second.text)}</div>
                `;
                await speak(second.text, second.lang);

                if (stopRequested || skipToNextWord) continue;

                await pauseDelay(pauseDuration * 1000);

                if (stopRequested || skipToNextWord) continue;

                // Repeat the Korean word (first word if Korean first, second word if English first)
                const repeatWord = firstWord === 'korean' ? first : second;
                await speak(repeatWord.text, repeatWord.lang);

                if (stopRequested || skipToNextWord) continue;

                // Hands-free mode: auto-advance after pause
                // Manual mode: wait for rating selection
                if (quizMode === 'manual') {
                    await waitForSkipToNext();
                } else if (i < orderedWords.length - 1) {
                    await pauseDelay(pauseDuration * 1000);
                }
            }

            endQuiz();
        }

        function waitForManualAdvance() {
            return new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (stopRequested || manualAdvance) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
        }

        function waitForSkipToNext() {
            return new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (stopRequested || skipToNextWord) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
        }

        function stopQuiz() {
            stopRequested = true;
            isPaused = false;
            window.speechSynthesis.cancel();
        }

        function endQuiz() {
            isQuizRunning = false;
            stopRequested = false;
            isPaused = false;
            currentQuizWord = null;
            quizMode = null;
            manualAdvance = false;
            skipToNextWord = false;

            // Reset UI
            document.getElementById('startPauseBtn').textContent = 'Pause';
            document.getElementById('startPauseBtn').classList.remove('btn-secondary');
            document.getElementById('startPauseBtn').style.display = '';
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('responseSection').classList.remove('visible');
            document.getElementById('btnReveal').classList.remove('visible');
            document.getElementById('ratingButtons').classList.remove('hidden');
            enableResponseButtons(false);

            document.getElementById('currentWord').innerHTML = '';
            document.getElementById('progress').textContent = '';

            // Show mode selection, hide quiz area
            document.getElementById('modeSelection').classList.remove('hidden');
            document.getElementById('quizActiveArea').classList.remove('visible');
        }

        function speak(text, lang) {
            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;

                const langCode = lang.split('-')[0];
                const voiceName = langCode === 'en' ? selectedVoices.en : selectedVoices.ko;

                if (voiceName) {
                    const voices = window.speechSynthesis.getVoices();
                    const voice = voices.find(v => v.name === voiceName);
                    if (voice) {
                        utterance.voice = voice;
                    }
                }

                utterance.rate = langCode === 'ko' ? koreanSpeed : 0.9;
                utterance.pitch = 1.0;

                utterance.onend = resolve;
                utterance.onerror = resolve;

                window.speechSynthesis.speak(utterance);
            });
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function pauseDelay(ms) {
            return new Promise(resolve => {
                const checkInterval = 100;
                let elapsed = 0;
                const interval = setInterval(() => {
                    if (stopRequested || skipToNextWord) {
                        clearInterval(interval);
                        resolve();
                        return;
                    }
                    if (!isPaused) {
                        elapsed += checkInterval;
                    }
                    if (elapsed >= ms) {
                        clearInterval(interval);
                        resolve();
                    }
                }, checkInterval);
            });
        }
    </script>
</body>

</html>